<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <title>Tabular-JSON playground</title>

    <script type="importmap">
      {
        "imports": {
          "csv42": "./node_modules/csv42/lib/esm/index.js"
        }
      }
    </script>

    <style>
      :root {
        --padding: 10px;
        --background: #f5f5f5;
        --border: 1px solid #bfbfbf;
        --error-color: #e81b1b;
        --link-color: #e81b1b;
        --link-color-highlight: #c10e0e;
        --theme-color: #1e90ff;
      }

      html,
      body {
        width: 100%;
        height: 100%;
        padding: 0;
        margin: 0;
      }

      body {
        font-family: verdana, sans-serif;
        display: flex;
        flex-direction: column;
      }

      h1 {
        font-weight: lighter;
        background: var(--theme-color);
        color: white;
        padding: var(--padding);
        margin: 0;
      }

      h2 {
        font-weight: bold;
        font-size: inherit;
        font-family: inherit;
        display: inline;
        margin: 0;
        padding: 0;
      }

      .columns {
        background: var(--background);
        flex: 1;
        display: flex;

        .column {
          flex: 1;
          display: flex;
          flex-direction: column;
          gap: calc(0.5 * var(--padding));
          padding: var(--padding);

          .title {
            display: flex;
            gap: calc(0.5 * var(--padding));
            align-items: center;
            min-height: 30px;

            .json-title {
              flex: 1;

              a {
                color: var(--link-color);

                &:hover {
                  color: var(--link-color-highlight);
                }
              }
            }

            .beautify {
              flex: 1;
              text-align: right;

              label,
              input {
                cursor: pointer;
              }
            }

            button {
              font-family: inherit;
              font-size: inherit;
              cursor: pointer;
            }
          }

          label.textarea {
            flex: 1;
            display: flex;
            flex-direction: column;

            textarea {
              flex: 1;
              border: var(--border);
              border-radius: 3px;
              resize: none;

              &.error {
                color: var(--error-color);
              }
            }
          }
        }
      }
    </style>
  </head>
  <body>
    <h1>Tabular-JSON playground</h1>
    <div class="columns">
      <div class="column">
        <div class="title">
          <div class="json-title">
            <h2>JSON</h2>
            <a href="#" id="example1">example1</a>
            <a href="#" id="example2">example2</a>
            <a href="#" id="example3">example3</a>
          </div>
          <button id="beautify">Beautify</button>
          <button id="smart-beautify">Smart Beautify</button>
          <button id="minify">Minify</button>
        </div>
        <label class="textarea">
          <textarea id="input"></textarea>
        </label>
        <div id="input-size"></div>
      </div>
      <div class="column">
        <div class="title">
          <h2>Tabular-JSON</h2>
          <div class="beautify">
            <label>
              Beautify
              <input id="beautify-option" type="checkbox" checked />
            </label>
          </div>
        </div>
        <label class="textarea">
          <textarea id="output"></textarea>
        </label>
        <div id="output-size"></div>
      </div>
    </div>

    <script type="module">
      import { stringify } from './dist/esm/index.js'

      const input = document.getElementById('input')
      const inputSize = document.getElementById('input-size')
      const output = document.getElementById('output')
      const outputSize = document.getElementById('output-size')
      const beautifyOption = document.getElementById('beautify-option')
      const beautify = document.getElementById('beautify')
      const smartBeautify = document.getElementById('smart-beautify')
      const minify = document.getElementById('minify')

      const example1 = {
        name: 'rob',
        hobbies: ['swimming', 'biking'],
        address: { city: 'New York', street: '1st Ave' },
        friends: [
          { id: 2, name: 'joe', address: { city: 'New York', street: '1st Ave' } },
          { id: 3, name: 'sarah', address: { city: 'Washington', street: '18th Street NW' } }
        ]
      }

      const example2 = {
        name: 'Richard',
        age: 33,
        hobbies: ['Biking', 'Gaming', 'Squash'],
        city: 'Port Land',
        friends: [
          { name: 'Chris', age: 23, city: 'New York' },
          { name: 'Emily', age: 19, city: 'Atlanta' },
          { name: 'Joe', age: 32, city: 'San Diego' },
          { name: 'Kevin', age: 19, city: 'Indianapolis' },
          { name: 'Michelle', age: 27, city: 'Los Angeles' },
          { name: 'Robert', age: 45, city: 'Manhattan' },
          { name: 'Sarah', age: 31, city: 'Chicago' },
          { name: 'Brandon', age: 42, city: 'Houston' },
          { name: 'Rachel', age: 55, city: 'Philadelphia' },
          { name: 'Christina', age: 22, city: 'Denver' }
        ]
      }

      const example3 = [
        { name: 'Chris', age: 23, city: 'New York' },
        { name: 'Emily', age: 19, city: 'Atlanta' },
        { name: 'Joe', age: 32, city: 'San Diego' },
        { name: 'Kevin', age: 19, city: 'Indianapolis' },
        { name: 'Michelle', age: 27, city: 'Los Angeles' },
        { name: 'Robert', age: 45, city: 'Manhattan' },
        { name: 'Sarah', age: 31, city: 'Chicago' },
        { name: 'Brandon', age: 42, city: 'Houston' },
        { name: 'Rachel', age: 55, city: 'Philadelphia' },
        { name: 'Christina', age: 22, city: 'Denver' }
      ]

      function percentage(a, b) {
        return Math.round((a / b) * 100) + '%'
      }

      function update() {
        output.classList.remove('error')

        const inputLength = input.value.length
        const inputLineCount = input.value.split('\n').length
        inputSize.innerText = `Size: ${inputLength} bytes, ${inputLineCount} lines`

        try {
          if (input.value.trim() !== '') {
            const json = JSON.parse(input.value)
            output.value = stringify(json, beautifyOption.checked ? { indentation: 2 } : undefined)

            const outputLength = output.value.length
            const outputLineCount = output.value.split('\n').length
            outputSize.innerText =
              `Size: ${outputLength} bytes (${percentage(outputLength, inputLength)}), ` +
              `${outputLineCount} lines (${percentage(outputLineCount, inputLineCount)})`
          } else {
            output.value = ''
            outputSize.innerText = ''
          }
        } catch (err) {
          output.value = err.toString()
          output.classList.add('error')
          outputSize.innerText = ''
        }
      }
      export async function smartFormat(text, indentation, maxLineLength) {
        const { Formatter, FracturedJsonOptions, NumberListAlignment } = await import(
          'https://cdn.jsdelivr.net/npm/fracturedjsonjs@4.0.0/+esm'
        )

        const options = new FracturedJsonOptions()
        options.MaxTotalLineLength = maxLineLength
        options.CommaPadding = true
        options.OmitTrailingWhitespace = true
        options.UseTabToIndent = indentation === '\t'
        options.IndentSpaces =
          typeof indentation === 'number' ? indentation : indentation?.length || 2
        options.MaxInlineComplexity = 1
        options.NumberListAlignment = NumberListAlignment.Decimal // we do not want to alter the formatting of numbers

        const formatter = new Formatter()
        formatter.Options = options

        return formatter.Reformat(text)
      }

      function beautifyJson() {
        try {
          const json = JSON.parse(input.value)
          input.value = JSON.stringify(json, null, 2)
        } catch (err) {
          alert(err.toString())
        }
      }

      async function smartBeautifyJson() {
        try {
          input.value = await smartFormat(input.value, 2, 80)
        } catch (err) {
          alert(err.toString())
        }
      }

      function minifyJson() {
        try {
          const json = JSON.parse(input.value)
          input.value = JSON.stringify(json)
        } catch (err) {
          alert(err.toString())
        }
      }

      input.value = JSON.stringify(example1, null, 2)
      input.addEventListener('input', () => update())
      beautifyOption.addEventListener('change', () => update())
      update()

      beautify.addEventListener('click', () => {
        beautifyJson()
        update()
      })

      smartBeautify.addEventListener('click', async () => {
        await smartBeautifyJson()
        update()
      })

      minify.addEventListener('click', () => {
        minifyJson()
        update()
      })

      document.getElementById('example1').addEventListener('click', (event) => {
        event.preventDefault()
        input.value = JSON.stringify(example1, null, 2)
        update()
      })

      document.getElementById('example2').addEventListener('click', (event) => {
        event.preventDefault()
        input.value = JSON.stringify(example2, null, 2)
        update()
      })

      document.getElementById('example3').addEventListener('click', (event) => {
        event.preventDefault()
        input.value = JSON.stringify(example3, null, 2)
        update()
      })
    </script>
  </body>
</html>
